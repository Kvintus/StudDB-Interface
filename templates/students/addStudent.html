<% extends "main_template.html" %>
    <% block title %>Add student
        <%endblock%>
            <% block content %>

                <div id="vs-main-vue" class="container vs-main-con">
                    <div id="alertMessage" style="margin-bottom: 20px; display:none;" class="alert alert-danger alert-dismissible fade show"
                        role="alert">
                        <button type="button" class="close" id="alertDismiss" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                        <p style="margin-bottom: 0;">Alert</p>

                    </div>
                    <div class="row">
                        <h1 class="card-heading">Student:</h1>
                    </div>
                    <form id="validationForm"></form>
                    <div class="row">
                        <div class="col prof-image-con">
                            <img v-bind:src="image" alt="">
                        </div>
                        <div class="col vs-text-con">
                            <div>

                                <table>
                                    <tr>
                                        <td style="padding-right: 80px;" class="vs-table-info">
                                            <p>Name:</p>
                                        </td>
                                        <td>
                                            <div style="margin-bottom:1rem;" class="col-sm-10">
                                                <input data-validation="name" id="nameInput" class="form-control is-invalid" placeholder="Name" type="text" onkeyup="checkkValidity(event)">
                                            </div>

                                        </td>
                                    </tr>
                                    <tr>
                                        <td class="vs-table-info">
                                            <p>Surname: </p>
                                        </td>
                                        <td>
                                            <div style="margin-bottom:1rem;" class="col-sm-10">
                                                <input data-validation="surname" v-model="surname" id="surnameInput" class="form-control is-invalid" placeholder="Surname" onkeyup="checkkValidity(event)">
                                            </div>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td class="vs-table-info">
                                            <p>Start: </p>
                                        </td>
                                        <td>
                                            <div style="margin-bottom:1rem;" class="col-sm-10">
                                                <input onkeyup="checkkValidity(event)" data-validation="start" id="startInput" class="form-control is-invalid" placeholder="Year"
                                                    type="number">
                                            </div>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td class="vs-table-info">
                                            <p>Class ID: </p>
                                        </td>
                                        <td>
                                            <div style="margin-bottom:1rem;" class="col-sm-10">
                                                <input id="classIDInput" class="form-control" placeholder="Class ID" type="number">
                                            </div>
                                        </td>
                                    </tr>

                                </table>

                            </div>
                        </div>
                    </div>
                    <hr>
                    <div class="row">
                        <div style="margin-left: 20px; display:flex;align-items: center;" class="col">
                            <table>
                                <tr>
                                    <td style="padding-right: 50px;" class="vs-table-info">
                                        <p>
                                            <i class="fa fa-envelope" aria-hidden="true"></i>
                                        </p>
                                    </td>
                                    <td>
                                        <div style="margin-bottom:1rem;" class="col-sm-12">
                                            <input id="emailInput" class="form-control" placeholder="Email" type="text">
                                        </div>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="vs-table-info">
                                        <p>
                                            <i class="fa fa-phone" aria-hidden="true"></i>
                                        </p>
                                    </td>
                                    <td>
                                        <div style="margin-bottom:1rem;" class="col-sm-12">
                                            <input id="phoneInput" class="form-control" placeholder="Phone number">
                                        </div>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="vs-table-info">
                                        <p class="no-bottom-margin">
                                            <i class="fa fa-home" aria-hidden="true"></i>
                                        </p>
                                    </td>
                                    <td>
                                        <div style="margin-bottom:1rem;" class="col-sm-12">
                                            <input id="adressInput" class="form-control" placeholder="Adress">
                                        </div>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="vs-table-info">
                                        <p class="no-bottom-margin">
                                            <i class="fa fa-birthday-cake" aria-hidden="true"></i>
                                        </p>
                                    </td>
                                    <td>
                                        <div class="col-sm-12">
                                            <input onkeyup="checkkValidity(event)" data-validation="birth" id="birthInput" type="date" class="form-control is-invalid"
                                                placeholder="Birthday">
                                        </div>
                                    </td>
                                </tr>
                            </table>
                        </div>
                        <div class="col main-parent-con">
                            <div>
                                <p class="view-rel-headline">Parents</p>
                                <p id="add-parent-button">
                                    <i class="fa fa-plus-circle" aria-hidden="true"></i>
                                </p>
                                <div class="parents-con">
                                </div>

                            </div>
                        </div>
                    </div>
                    <div class="row manipulate-buttons-con">
                        <button id="updateStudent" class="btn btn-outline-primary">Save</button>
                    </div>
                </div>

                <script>
                    new Vue({
                        el: '#vs-main-vue',
                        data: {
                            surname: ''
                        },
                        computed: {
                            image: function(){
                                if ( (this.surname.indexOf('ova') > -1) || (this.surname.indexOf('ovÃ¡') > -1)){
                                    return "%% url_for('static', filename='images/placeholder_female.jpg') %%"
                                } else {
                                    return "%% url_for('static', filename='images/placeholder_male.jpg') %%"
                                }
                            }
                        }
                    })
                </script>
                <script>
                    let regexp = new RegExp("^\\+([0-9]{3})\x20([0-9]{3})\x20([0-9]{3})\x20([0-9]{3})$");
                    let emailReg = /^(([^<>()\[\]\.,;:\s@\"]+(\.[^<>()\[\]\.,;:\s@\"]+)*)|(\".+\"))@(([^<>()[\]\.,;:\s@\"]+\.)+[^<>()[\]\.,;:\s@\"]{2,})$/i;
                    let requiredInputs = {
                        'name': false,
                        'surname': false,
                        'birth': false,
                        'start': false
                    }
                    // Validation
                    function checkkValidity(event) {
                        let $target = $(event.target);
                        if ($target.val() === '') {
                            $target.addClass('is-invalid')
                            requiredInputs[$target.attr('data-validation')] = false;
                        } else {
                            $target.removeClass('is-invalid')
                            requiredInputs[$target.attr('data-validation')] = true;
                        }
                    }

                    function getStudentData() {
                        postStudent = {
                            'name': $('#nameInput').val(),
                            'surname': $('#surnameInput').val(),
                            'start': $('#startInput').val(),
                            'birth': $('#birthInput').val(),
                            'classID': parseInt($('#classIDInput').val()),
                            'email': $('#emailInput').val(),
                            'phone': $('#phoneInput').val(),
                            'adress': $('#adressInput').val(),
                            'parents': []
                        };

                        // Appending all the parents found
                        $('.parentIDInput').each(function () {
                            postStudent['parents'].push(parseInt($(this).val()));
                        });
                        return postStudent
                    }

                    function postData(dataToPost) {
                        $.ajax({
                            type: "post",
                            url: "%% url_for('addStudentRoute') %%",
                            // The key needs to match your method's input parameter (case-sensitive).
                            data: JSON.stringify(dataToPost),
                            contentType: "application/json; charset=utf-8",
                            dataType: "json",
                            success: function (data) {
                                if (!('message' in data)) {
                                    window.location.href = "%% url_for('viewStudent') %%" + '?id=' + data.studentID;
                                } else {
                                    console.log(data);
                                    $('#alertMessage').find('p').text(data.message);
                                    $('#alertMessage').show(200);
                                }
                            },
                            failure: function (errMsg) {
                                alert(errMsg);
                            }
                        });
                    }

                    function hideParent(thiso) {
                        $(thiso).parent().fadeOut(100);
                        $(thiso).parent().remove();
                    }


                    $(function () {

                        // Make refs to parent pages
                        parents = document.getElementsByClassName('relative-ref');

                        for (let index = 0; index < parents.length; index++) {
                            let adress = "%% url_for('viewParent') %%" + '?id=' + parents[index].getAttribute(
                                'data-parentID');
                            parents[index].setAttribute('href', adress);
                        }

                        // Make refs to Class page
                        // Doing it dynamically with loop prevents out of index error if there are no class-ref elements
                        classRef = document.getElementsByClassName('class-ref')
                        for (let index = 0; index < classRef.length; index++) {
                            let adress = "%% url_for('viewClass') %%" + '?id=' + classRef[index].getAttribute(
                                'data-classID');
                            classRef[index].setAttribute('href', adress);
                        }

                        $('#alertDismiss').on('click', () => {
                            $('#alertMessage').hide(200);
                        })


                        $("#updateStudent").on('click', () => {
                            // Creating a student to post
                            // Validate
                            let allValid = true;
                            for (key in requiredInputs) {
                                if (requiredInputs[key] === false) {
                                    allValid = false;
                                    7
                                }
                            }

                            if (allValid) {
                                postData(getStudentData())
                            } else {
                                $('#alertMessage').find('p').text('All fields in red are required!');
                                $('#alertMessage').show(200);
                            }
                        });

                        $parentCon = $('.parents-con').first();
                        inputParentField =
                            '<div class="col-sm-10 parent-wrapper"><input class="form-control parentIDInput" type="number"><i onclick="hideParent(this)" class="fa fa-times" aria-hidden="true"></i></div>';
                        $('#add-parent-button').on('click', () => {
                            $parentCon.append(inputParentField);
                        });

                        $("#phoneInput").blur(function () {
                            var no = $("#phoneInput").val();
                            if (!regexp.test(no)) {
                                console.log('peter');
                                $('#alertMessage').find('p').text(
                                    'Invalid telephone number format | Example: +421 948 555 555');
                                $('#alertMessage').show(200);
                            }

                        });


                        $("#emailInput").blur(function () {
                            var emailVal = $("#emailInput").val();
                            if (!emailReg.test(emailVal) && emailVal.length > 0) {
                                $('#alertMessage').find('p').text(
                                    'Invalid email adress format | Example: guest@gmail.com');
                                $('#alertMessage').show(200);
                            }
                        });
                    })
                </script>

                <% endblock %>