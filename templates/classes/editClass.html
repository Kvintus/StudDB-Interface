<% extends "main_template.html" %>
    <% block title %>
        <% if 'altname' in rclass %>
            %% rclass['altname'] %%
            <% else %>
                %% rclass['name'] %%
                <% endif %>
                    <%endblock%>
                        <% block content %>
                            <div style="padding-left: 50px;" class="container vs-main-con">
                                <div id="alertMessage" style="margin-bottom: 20px; display:none;" class="alert alert-danger alert-dismissible fade show"
                                    role="alert">
                                    <button type="button" class="close" id="alertDismiss" aria-label="Close">
                                        <span aria-hidden="true">&times;</span>
                                    </button>
                                    <p style="margin-bottom: 0;">Alert</p>
                                </div>
                                <div style="margin-bottom: 2rem;" class="row">
                                    <h1 style="margin-left: 0;" class="card-heading">Class:
                                        <% if 'altname' in rclass %>
                                            %% rclass['altname'] %% (%% rclass['name'] %%)
                                            <% else %>
                                                %% rclass['name'] %%
                                                <% endif %>
                                    </h1>
                                </div>
                                <div class="row">
                                    <div style="align-items: flex-start; " class="col">
                                        <p style="font-size: 2rem; margin-bottom: 1.3rem" class="view-rel-headline">Info: </p>
                                        <br>
                                        <div class="class-info">
                                            <table>
                                                <tr>
                                                    <td style="padding-right: 90px;" class="vs-table-info">
                                                        <p>Name:</p>
                                                    </td>
                                                    <td>
                                                        <p>
                                                            <% if 'altname' in rclass %>
                                                                %% rclass['altname'] %% (%% rclass['name'] %%)
                                                                <% else %>
                                                                    %% rclass['name'] %%
                                                                    <% endif %>
                                                        </p>
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <td class="vs-table-info">
                                                        <p>Class teacher:</p>
                                                    </td>
                                                    <td>
                                                        <div style="margin-bottom:1rem;" class="col-sm-10">
                                                            <% if rclass['professors']|length %>
                                                                <input data-validation="teacher" id="teacherIDInput" class="form-control" value="%% rclass['professors'][0]['id'] %%" placeholder="%% rclass['professors'][0]['id'] %%"
                                                                    onkeyup="checkkValidity(event)" type="number">
                                                                <% else %>
                                                                    <input data-validation="teacher" id="teacherIDInput" class="form-control" onkeyup="checkkValidity(event)" type="number">
                                                                    <% endif %>
                                                        </div>
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <td class="vs-table-info">
                                                        <p>Letter:</p>
                                                    </td>
                                                    <td>
                                                        <div style="margin-bottom:1rem;" class="col-sm-10">
                                                            <input data-validation="letter" id="letterInput" class="form-control" value="%% rclass['letter']%%" placeholder="%% rclass['letter']%%"
                                                                onkeyup="checkkValidity(event)">
                                                        </div>
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <td class="vs-table-info">
                                                        <p>Room: </p>
                                                    </td>
                                                    <td>
                                                        <div style="margin-bottom:1rem;" class="col-sm-10">
                                                            <input data-validation="room" id="roomInput" class="form-control" value="%% rclass['room'] %%" placeholder="%% rclass['room'] %%"
                                                                onkeyup="checkkValidity(event)">
                                                        </div>
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <td class="vs-table-info">
                                                        <p>Start: </p>
                                                    </td>
                                                    <td>
                                                        <div style="margin-bottom:1rem;" class="col-sm-10">
                                                            <input data-validation="start" id="startInput" class="form-control" value="%% rclass['start'] %%" placeholder="%% rclass['start'] %%"
                                                                onkeyup="checkkValidity(event)" type="number">
                                                        </div>
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <td class="vs-table-info">
                                                        <p>ID:</p>
                                                    </td>
                                                    <td>
                                                        <p class="vs-gray-info">%% rclass['id'] %%</p>
                                                    </td>
                                                </tr>
                                            </table>
                                        </div>
                                    </div>
                                    <div class="col main-parent-con">
                                        <div class="students-wrapper">
                                            <p style="font-size: 2rem; margin-bottom: 1.3rem" class="view-rel-headline">Students: </p>
                                            <p id="add-parent-button">
                                                <i class="fa fa-plus-circle" aria-hidden="true"></i>
                                            </p>
                                            <div style="margin-left: 50px" class="parents-con">
                                                <% for pupil in rclass['pupils'] %>
                                                    <div class="col-sm-10 parent-wrapper">
                                                        <input class="form-control pupilIDInput" value="%% pupil['id'] %%" placeholder="%% pupil['id'] %%" type="number">
                                                        <i onclick="hideParent(this)" class="fa fa-times" aria-hidden="true"></i>
                                                    </div>
                                                    <% endfor %>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <% if userPrivilege >= 3 %>
                                    <div class="row manipulate-buttons-con">
                                        <div id="cancel-button-wrapper">
                                            <button id="cancelEdit" class="btn btn-outline-secondary">Cancel</button>
                                        </div>
                                        <button id="updateClass" class="btn btn-outline-primary">Save</button>
                                        <button id="deleteClass" class="btn btn-outline-danger">
                                            Delete
                                        </button>
                                    </div>
                                    <% endif %>
                            </div>

                            <script>
                                // Gets automatically populated with the function below
                                let requiredInputs = {}
                                let errorMessage = '';


                                // Validation
                                function checkkValidity(event) {
                                    let $target = $(event.target);
                                    if ($target.val() === '') {
                                        $target.addClass('is-invalid')
                                        requiredInputs[$target.attr('data-validation')] = false;
                                        errorMessage = 'All fields in red are required!';
                                    } else {
                                        $target.removeClass('is-invalid')
                                        requiredInputs[$target.attr('data-validation')] = true;
                                    }
                                }

                                function getIsoFormatDate(date) {
                                    if (date.indexOf('.') > -1) {
                                        let partsOfTheDate = date.split('.');
                                        let newDate = new Date(partsOfTheDate[2], partsOfTheDate[1], partsOfTheDate[0]);

                                        year = newDate.getFullYear();
                                        month = newDate.getMonth() + 1;
                                        dt = newDate.getDate();

                                        if (dt < 10) {
                                            dt = '0' + dt;
                                        }
                                        if (month < 10) {
                                            month = '0' + month;
                                        }


                                        return year + '-' + month + '-' + dt;
                                    } else {
                                        return date
                                    }
                                }


                                function getClassData() {
                                    postClass = {
                                        'id': parseInt("%% rclass['id'] %%"),
                                        'start': $('#startInput').val(),
                                        'room': $('#roomInput').val(),
                                        'letter': $('#letterInput').val(),
                                        'professors': [],
                                        'pupils': []
                                    };

                                    // Appending all the parents found
                                    $('.pupilIDInput').each(function () {
                                        postClass['pupils'].push(parseInt($(this).val()));
                                    });

                                    // Appending all the parents found
                                    $('#teacherIDInput').each(function () {
                                        postClass['professors'].push(parseInt($(this).val()));
                                    });


                                    return postClass
                                }

                                function postData(dataToPost) {
                                    $.ajax({
                                        type: "post",
                                        url: "%% url_for('updateClassRoute') %%",
                                        // The key needs to match your method's input parameter (case-sensitive).
                                        data: JSON.stringify(dataToPost),
                                        contentType: "application/json; charset=utf-8",
                                        dataType: "json",
                                        success: function (data) {
                                            if (!('message' in data)) {
                                                window.location.href = "%% url_for('viewClass') %%" +
                                                    '?id=' +
                                                    "%% rclass['id'] %%";
                                            } else {
                                                $('#alertMessage').find('p').text(data.message);
                                                $('#alertMessage').show(200);
                                            }
                                        },
                                        failure: function (errMsg) {
                                            console.log(errMsg);
                                        }
                                    });
                                }

                                function hideParent(thiso) {
                                    $(thiso).parent().fadeOut(100);
                                    $(thiso).parent().remove();
                                }


                                $(function () {

                                    $('#alertDismiss').on('click', () => {
                                        $('#alertMessage').hide(200);
                                    });

                                    $('#deleteClass').on('click', (event) => {
                                        let tempClass = {
                                            'id': "%% rclass['id'] %%"
                                        };
                                        $.ajax({
                                            type: "post",
                                            url: "%% url_for('deleteClassRoute') %%",
                                            // The key needs to match your method's input parameter (case-sensitive).
                                            data: JSON.stringify(tempClass),
                                            contentType: "application/json; charset=utf-8",
                                            dataType: "json",
                                            success: function (data) {
                                                if (!('message' in data)) {
                                                    window.location.href =
                                                        "%% url_for('classes') %%";
                                                } else {
                                                    console.log(data)
                                                }
                                            },
                                            failure: function (errMsg) {
                                                alert(errMsg);
                                            }
                                        });
                                    });

                                    $('#cancelEdit').on('click', () => {
                                        window.location.href = "%% url_for('viewClass') %%" +
                                            '?id=' +
                                            "%% rclass['id'] %%"
                                    });

                                    $("#updateClass").on('click', () => {
                                        // Creating a student to post
                                        // Validate
                                        let allValid = true;
                                        for (key in requiredInputs) {
                                            if (requiredInputs[key] === false) {
                                                allValid = false;
                                            }
                                        }

                                        if (allValid) {
                                            postData(getClassData())
                                        } else {
                                            $('#alertMessage').find('p').text(errorMessage);
                                            $('#alertMessage').show(200);
                                        }
                                    });

                                    $parentCon = $('.parents-con').first();
                                    inputParentField =
                                        '<div class="col-sm-10 parent-wrapper"><input class="form-control pupilIDInput" type="number"><i onclick="hideParent(this)" class="fa fa-times" aria-hidden="true"></i></div>';

                                    $('#add-parent-button').on('click', () => {
                                        $parentCon.prepend(inputParentField);
                                    })
                                })
                            </script>

                            <% endblock %>